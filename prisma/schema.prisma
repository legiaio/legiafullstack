// Legia Professional Services Marketplace Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Authentication & User Management
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? 
  access_token      String? 
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? 
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  CLIENT
  PROFESSIONAL
  ADMIN
  FINANCE
  MODERATION
}

enum ServiceType {
  CONTRACTOR
  ARCHITECT
  INTERIOR_DESIGNER
  DESIGN_BUILD
}

enum RoomStyle {
  MODERN
  CLASSIC
  MINIMALIST
  INDUSTRIAL
  SCANDINAVIAN
  BOHEMIAN
  TRADITIONAL
  CONTEMPORARY
}

enum ProjectStatus {
  PENDING
  ACCEPTED
  CANCELLED
  IN_PROGRESS
  COMPLETED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  EXPIRED
  CANCELLED
}

enum PaymentGateway {
  MIDTRANS
  XENDIT
  TRIPAY
}

enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
  INCOMPLETE
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(CLIENT)
  phone         String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  latitude      Float?
  longitude     Float?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  professional  Professional?
  clientProjects Project[] @relation("ClientProjects")
  orders        Order[]
  reviews       Review[]
  chatMessages  ChatMessage[]
  notifications Notification[]
  escrowTransactions EscrowTransaction[]
  disputesRaised EscrowDispute[] @relation("DisputesRaised")
  disputesResolved EscrowDispute[] @relation("DisputesResolved")
  
  // Project Management Relations
  clientProjectManagement ProjectManagement[] @relation("ClientProjectManagement")
  professionalProjectManagement ProjectManagement[] @relation("ProfessionalProjectManagement")
  assignedTasks ProjectTask[] @relation("AssignedTasks")
  sentProjectMessages ProjectMessage[] @relation("SentProjectMessages")
  uploadedProjectFiles ProjectFile[] @relation("UploadedProjectFiles")
  taskComments TaskComment[] @relation("TaskComments")

  @@map("users")
}

model Professional {
  id                String        @id @default(cuid())
  userId            String        @unique
  businessName      String
  description       String        
  serviceTypes      Json // ServiceType[]
  experience        Int // years of experience
  minBudget         Float       
  maxBudget         Float       
  rating            Float         @default(0)
  totalReviews      Int           @default(0)
  completedProjects Int           @default(0)
  kycStatus         KYCStatus     @default(PENDING)
  kycDocuments      Json?
  isVerified        Boolean       @default(false)
  isActive          Boolean       @default(true)
  balance           Float       @default(0) 
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  portfolios        Portfolio[]
  projects          Project[]   @relation("ProfessionalProjects")
  reviews           Review[]
  chatRooms         ChatRoom[]
  termProgresses    TermProgress[]
  orderItems        OrderItem[]

  @@map("professionals")
}

model Service {
  id          String   @id @default(cuid())
  title       String
  description String   
  category    String
  price       Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  projectManagement ProjectManagement[]

  @@map("services")
}

model Portfolio {
  id             String      @id @default(cuid())
  professionalId String
  title          String
  description    String      
  serviceType    ServiceType
  roomStyle      RoomStyle
  images         Json // String[]
  price          Float     
  duration       Int // days
  features       Json // String[]
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  orderItems   OrderItem[]

  @@map("portfolios")
}

model Project {
  id               String        @id @default(cuid())
  clientId         String
  professionalId   String?
  serviceType      ServiceType
  landArea         Float?
  jobDescription   String        
  location         String
  estimatedBudget  Float       
  roomStyle        RoomStyle
  timeline         Int // days
  referenceImages  Json // String[]
  aiGeneratedImage String?
  aiAnalysis       Json?
  status           ProjectStatus @default(PENDING)
  totalPrice       Float?      
  vatAmount        Float?      
  feeAmount        Float?      
  paymentTerms     Int?
  contractData     Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  client         User           @relation("ClientProjects", fields: [clientId], references: [id])
  professional   Professional?  @relation("ProfessionalProjects", fields: [professionalId], references: [id])
  orders         Order[]
  chatRooms      ChatRoom[]
  termProgresses TermProgress[]
  reviews        Review[]

  @@map("projects")
}

model Order {
  id              String         @id @default(cuid())
  userId          String
  projectId       String?
  orderNumber     String         @unique
  totalAmount     Float        
  vatAmount       Float        
  feeAmount       Float        
  status          OrderStatus    @default(PENDING)
  paymentStatus   PaymentStatus  @default(PENDING)
  paymentGateway  PaymentGateway?
  paymentData     Json?
  shippingAddress Json
  paymentTerms    Int
  termAmounts     Json // Array of amounts per term
  paidAt          DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  user            User          @relation(fields: [userId], references: [id])
  project         Project?      @relation(fields: [projectId], references: [id])
  orderItems      OrderItem[]
  payments        Payment[]
  escrows         Escrow[]
  paymentTermList PaymentTerm[]

  @@map("orders")
}

model OrderItem {
  id               String  @id @default(cuid())
  orderId          String
  professionalId   String
  portfolioId      String
  portfolioTitle   String
  portfolioPrice   Float 
  portfolioImage   String?
  serviceType      String
  projectBrief     Json?
  quantity         Int     @default(1)

  // Relations
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  professional Professional @relation(fields: [professionalId], references: [id])
  portfolio    Portfolio    @relation(fields: [portfolioId], references: [id])

  @@map("order_items")
}

enum EscrowStatus {
  PENDING
  ACTIVE
  COMPLETED
  DISPUTED
  CANCELLED
  REFUNDED
}

enum EscrowTermStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  APPROVED
  RELEASED
  DISPUTED
}

enum EscrowTransactionType {
  DEPOSIT
  RELEASE
  REFUND
  FEE
  DISPUTE_HOLD
  DISPUTE_RELEASE
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  ESCALATED
  CLOSED
}

model Escrow {
  id            String        @id @default(cuid())
  orderId       String
  totalAmount   Float       
  heldAmount    Float       
  releasedAmount Float      @default(0) 
  status        EscrowStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id])
  terms EscrowTerm[]
  transactions EscrowTransaction[]
  disputes EscrowDispute[]

  @@map("escrows")
}

model EscrowTerm {
  id              String           @id @default(cuid())
  escrowId        String
  termNumber      Int
  name            String
  description     String           
  percentage      Int
  amount          Float          
  status          EscrowTermStatus @default(PENDING)
  dueDate         DateTime?
  completedAt     DateTime?
  approvedAt      DateTime?
  releasedAt      DateTime?
  documentation   Json             // String[]
  approvalRequired Boolean         @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  escrow Escrow @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  transactions EscrowTransaction[]
  disputes EscrowDispute[]

  @@unique([escrowId, termNumber])
  @@map("escrow_terms")
}

model EscrowTransaction {
  id          String                @id @default(cuid())
  escrowId    String
  type        EscrowTransactionType
  amount      Float               
  description String                
  termId      String?
  paymentId   String?
  createdBy   String
  metadata    Json?
  createdAt   DateTime              @default(now())

  // Relations
  escrow Escrow @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  term   EscrowTerm? @relation(fields: [termId], references: [id])
  creator User @relation(fields: [createdBy], references: [id])

  @@map("escrow_transactions")
}

model EscrowDispute {
  id          String        @id @default(cuid())
  escrowId    String
  termId      String?
  raisedBy    String
  reason      String
  description String        
  evidence    Json          // String[]
  status      DisputeStatus @default(OPEN)
  resolution  String?
  resolvedBy  String?
  resolvedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  escrow Escrow @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  term   EscrowTerm? @relation(fields: [termId], references: [id])
  raiser User @relation("DisputesRaised", fields: [raisedBy], references: [id])
  resolver User? @relation("DisputesResolved", fields: [resolvedBy], references: [id])

  @@map("escrow_disputes")
}

model PaymentTerm {
  id          String        @id @default(cuid())
  orderId     String
  name        String
  percentage  Int
  amount      Float       
  description String
  status      PaymentStatus @default(PENDING)
  sequence    Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payment_terms")
}

model Payment {
  id              String         @id @default(cuid())
  orderId         String
  gateway         PaymentGateway
  amount          Float        
  paidAmount      Float?       
  currency        String         @default("IDR")
  status          PaymentStatus  @default(PENDING)
  paymentMethod   String?
  paymentUrl      String?
  qrCode          String?
  virtualAccount  String?
  expiryTime      DateTime?
  transactionTime DateTime?
  settlementTime  DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model WebhookLog {
  id        String         @id @default(cuid())
  gateway   PaymentGateway
  paymentId String
  orderId   String
  status    String
  payload   String         // JSON string
  signature String?
  processed Boolean        @default(false)
  error     String?
  createdAt DateTime       @default(now())

  @@map("webhook_logs")
}

model TermProgress {
  id             String    @id @default(cuid())
  projectId      String
  professionalId String
  termNumber     Int
  amount         Float   
  description    String    
  documentation  Json // String[] - URLs to uploaded files
  isCompleted    Boolean   @default(false)
  isApproved     Boolean   @default(false)
  completedAt    DateTime?
  approvedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  project      Project      @relation(fields: [projectId], references: [id])
  professional Professional @relation(fields: [professionalId], references: [id])

  @@unique([projectId, termNumber])
  @@map("term_progresses")
}

model ChatRoom {
  id             String @id @default(cuid())
  projectId      String @unique
  professionalId String
  isActive       Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  project      Project       @relation(fields: [projectId], references: [id])
  professional Professional  @relation(fields: [professionalId], references: [id])
  messages     ChatMessage[]

  @@map("chat_rooms")
}

model ChatMessage {
  id         String   @id @default(cuid())
  chatRoomId String
  userId     String
  message    String   
  attachments Json // String[]
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@map("chat_messages")
}

model Review {
  id             String @id @default(cuid())
  projectId      String @unique
  userId         String
  professionalId String
  rating         Int // 1-5
  comment        String 
  images         Json // String[]
  createdAt      DateTime @default(now())

  // Relations
  project      Project      @relation(fields: [projectId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
  professional Professional @relation(fields: [professionalId], references: [id])

  @@map("reviews")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   
  type      String
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

// Admin & Settings
model AdminSettings {
  id                String   @id @default(cuid())
  key               String   @unique
  value             Json
  description       String?
  updatedAt         DateTime @updatedAt

  @@map("admin_settings")
}

model PaymentGatewayConfig {
  id          String         @id @default(cuid())
  gateway     PaymentGateway @unique
  isEnabled   Boolean        @default(false)
  config      Json // API keys, endpoints, etc.
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("payment_gateway_configs")
}

model AIModelConfig {
  id          String   @id @default(cuid())
  provider    String   @unique // "gemini", "openai", etc.
  isActive    Boolean  @default(false)
  config      Json     // API keys, model names, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ai_model_configs")
}

// Project Management System
enum ProjectManagementStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectManagementPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
  MILESTONE_UPDATE
  TASK_UPDATE
}

model ProjectManagement {
  id               String                     @id @default(cuid())
  title            String
  description      String                     
  status           ProjectManagementStatus    @default(DRAFT)
  priority         ProjectManagementPriority @default(MEDIUM)
  budget           Float
  currency         String                     @default("IDR")
  startDate        DateTime
  endDate          DateTime?
  clientId         String
  professionalId   String?
  serviceId        String
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt

  // Relations
  client       User                    @relation("ClientProjectManagement", fields: [clientId], references: [id])
  professional User?                   @relation("ProfessionalProjectManagement", fields: [professionalId], references: [id])
  service      Service                 @relation(fields: [serviceId], references: [id])
  tasks        ProjectTask[]
  milestones   ProjectMilestone[]
  messages     ProjectMessage[]
  files        ProjectFile[]

  @@map("project_management")
}

model ProjectTask {
  id          String       @id @default(cuid())
  projectId   String
  title       String
  description String?      
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  assignedTo  String?
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  project  ProjectManagement @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee User?             @relation("AssignedTasks", fields: [assignedTo], references: [id])
  comments TaskComment[]

  @@map("project_tasks")
}

model ProjectMilestone {
  id          String          @id @default(cuid())
  projectId   String
  title       String
  description String?         
  status      MilestoneStatus @default(PENDING)
  amount      Float
  dueDate     DateTime
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  project ProjectManagement @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_milestones")
}

model ProjectMessage {
  id        String      @id @default(cuid())
  projectId String
  senderId  String
  content   String      
  type      MessageType @default(TEXT)
  createdAt DateTime    @default(now())

  // Relations
  project     ProjectManagement   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sender      User                @relation("SentProjectMessages", fields: [senderId], references: [id])
  attachments MessageAttachment[]

  @@map("project_messages")
}

model ProjectFile {
  id           String   @id @default(cuid())
  projectId    String
  uploadedById String
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  createdAt    DateTime @default(now())

  // Relations
  project    ProjectManagement @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy User              @relation("UploadedProjectFiles", fields: [uploadedById], references: [id])

  @@map("project_files")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  authorId  String
  content   String   
  createdAt DateTime @default(now())

  // Relations
  task   ProjectTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User        @relation("TaskComments", fields: [authorId], references: [id])

  @@map("task_comments")
}

model MessageAttachment {
  id        String @id @default(cuid())
  messageId String
  filename  String
  url       String
  mimeType  String
  size      Int

  // Relations
  message ProjectMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("message_attachments")
}
