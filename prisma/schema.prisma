// Legia Professional Services Marketplace Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Authentication & User Management
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? 
  access_token      String? 
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? 
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  CLIENT
  PROFESSIONAL
  ADMIN
  FINANCE
  MODERATION
}

enum ServiceType {
  CONTRACTOR
  ARCHITECT
  INTERIOR_DESIGNER
  DESIGN_BUILD
}

enum RoomStyle {
  MODERN
  CLASSIC
  MINIMALIST
  INDUSTRIAL
  SCANDINAVIAN
  BOHEMIAN
  TRADITIONAL
  CONTEMPORARY
}

enum ProjectStatus {
  PENDING
  ACCEPTED
  CANCELLED
  IN_PROGRESS
  COMPLETED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentGateway {
  MIDTRANS
  XENDIT
  TRIPAY
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
  INCOMPLETE
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(CLIENT)
  phone         String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  latitude      Float?
  longitude     Float?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  professional  Professional?
  clientProjects Project[] @relation("ClientProjects")
  orders        Order[]
  reviews       Review[]
  chatMessages  ChatMessage[]
  notifications Notification[]

  @@map("users")
}

model Professional {
  id                String        @id @default(cuid())
  userId            String        @unique
  businessName      String
  description       String        
  serviceTypes      Json // ServiceType[]
  experience        Int // years of experience
  minBudget         Float       
  maxBudget         Float       
  rating            Float         @default(0)
  totalReviews      Int           @default(0)
  completedProjects Int           @default(0)
  kycStatus         KYCStatus     @default(PENDING)
  kycDocuments      Json?
  isVerified        Boolean       @default(false)
  isActive          Boolean       @default(true)
  balance           Float       @default(0) 
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  portfolios        Portfolio[]
  projects          Project[]   @relation("ProfessionalProjects")
  reviews           Review[]
  chatRooms         ChatRoom[]
  termProgresses    TermProgress[]
  orderItems        OrderItem[]

  @@map("professionals")
}

model Portfolio {
  id             String      @id @default(cuid())
  professionalId String
  title          String
  description    String      
  serviceType    ServiceType
  roomStyle      RoomStyle
  images         Json // String[]
  price          Float     
  duration       Int // days
  features       Json // String[]
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  orderItems   OrderItem[]

  @@map("portfolios")
}

model Project {
  id               String        @id @default(cuid())
  clientId         String
  professionalId   String?
  serviceType      ServiceType
  landArea         Float?
  jobDescription   String        
  location         String
  estimatedBudget  Float       
  roomStyle        RoomStyle
  timeline         Int // days
  referenceImages  Json // String[]
  aiGeneratedImage String?
  aiAnalysis       Json?
  status           ProjectStatus @default(PENDING)
  totalPrice       Float?      
  vatAmount        Float?      
  feeAmount        Float?      
  paymentTerms     Int?
  contractData     Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  client         User           @relation("ClientProjects", fields: [clientId], references: [id])
  professional   Professional?  @relation("ProfessionalProjects", fields: [professionalId], references: [id])
  orders         Order[]
  chatRooms      ChatRoom[]
  termProgresses TermProgress[]
  reviews        Review[]

  @@map("projects")
}

model Order {
  id              String         @id @default(cuid())
  userId          String
  projectId       String?
  orderNumber     String         @unique
  totalAmount     Float        
  vatAmount       Float        
  feeAmount       Float        
  paymentStatus   PaymentStatus  @default(PENDING)
  paymentGateway  PaymentGateway?
  paymentData     Json?
  shippingAddress Json
  paymentTerms    Int
  termAmounts     Json // Array of amounts per term
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  user            User          @relation(fields: [userId], references: [id])
  project         Project?      @relation(fields: [projectId], references: [id])
  orderItems      OrderItem[]
  escrows         Escrow[]
  paymentTermList PaymentTerm[]

  @@map("orders")
}

model OrderItem {
  id               String  @id @default(cuid())
  orderId          String
  professionalId   String
  portfolioId      String
  portfolioTitle   String
  portfolioPrice   Float 
  portfolioImage   String?
  serviceType      String
  projectBrief     Json?
  quantity         Int     @default(1)

  // Relations
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  professional Professional @relation(fields: [professionalId], references: [id])
  portfolio    Portfolio    @relation(fields: [portfolioId], references: [id])

  @@map("order_items")
}

model Escrow {
  id            String        @id @default(cuid())
  orderId       String
  totalAmount   Float       
  heldAmount    Float       
  releasedAmount Float      @default(0) 
  status        PaymentStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id])

  @@map("escrows")
}

model PaymentTerm {
  id          String        @id @default(cuid())
  orderId     String
  name        String
  percentage  Int
  amount      Float       
  description String
  status      PaymentStatus @default(PENDING)
  sequence    Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payment_terms")
}

model TermProgress {
  id             String    @id @default(cuid())
  projectId      String
  professionalId String
  termNumber     Int
  amount         Float   
  description    String    
  documentation  Json // String[] - URLs to uploaded files
  isCompleted    Boolean   @default(false)
  isApproved     Boolean   @default(false)
  completedAt    DateTime?
  approvedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  project      Project      @relation(fields: [projectId], references: [id])
  professional Professional @relation(fields: [professionalId], references: [id])

  @@unique([projectId, termNumber])
  @@map("term_progresses")
}

model ChatRoom {
  id             String @id @default(cuid())
  projectId      String @unique
  professionalId String
  isActive       Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  project      Project       @relation(fields: [projectId], references: [id])
  professional Professional  @relation(fields: [professionalId], references: [id])
  messages     ChatMessage[]

  @@map("chat_rooms")
}

model ChatMessage {
  id         String   @id @default(cuid())
  chatRoomId String
  userId     String
  message    String   
  attachments Json // String[]
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@map("chat_messages")
}

model Review {
  id             String @id @default(cuid())
  projectId      String @unique
  userId         String
  professionalId String
  rating         Int // 1-5
  comment        String 
  images         Json // String[]
  createdAt      DateTime @default(now())

  // Relations
  project      Project      @relation(fields: [projectId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
  professional Professional @relation(fields: [professionalId], references: [id])

  @@map("reviews")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   
  type      String
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

// Admin & Settings
model AdminSettings {
  id                String   @id @default(cuid())
  key               String   @unique
  value             Json
  description       String?
  updatedAt         DateTime @updatedAt

  @@map("admin_settings")
}

model PaymentGatewayConfig {
  id          String         @id @default(cuid())
  gateway     PaymentGateway @unique
  isEnabled   Boolean        @default(false)
  config      Json // API keys, endpoints, etc.
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("payment_gateway_configs")
}

model AIModelConfig {
  id          String   @id @default(cuid())
  provider    String   @unique // "gemini", "openai", etc.
  isActive    Boolean  @default(false)
  config      Json     // API keys, model names, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ai_model_configs")
}
